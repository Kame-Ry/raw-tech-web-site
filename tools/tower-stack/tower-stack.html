<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark light" />
<title>Tower Stacker</title>
<style>
  :root{
    --bg:#0f1115;           /* page */
    --bg2:#12151c;          /* gradient end */
    --panel:#151821;        /* cards */
    --panel-2:#12151c;
    --border:rgba(255,255,255,.08);
    --text:#e9edf2;
    --muted:#aab5c2;
    --accent:#ff7a18;       /* orange */
    --accent-600:#d96511;   /* darker hover */
    --ring:rgba(255,122,24,.28);
    --good:#63d18a;
    --bad:#ef5350;
    --gold:#fbbf24;
    --shadow:0 14px 36px rgba(0,0,0,.35);
    --radius:14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text); font:14px var(--sans);
    background:
      radial-gradient(900px 600px at 10% -10%, rgba(255,122,24,.10), transparent 60%),
      radial-gradient(800px 500px at 110% 10%, rgba(255,122,24,.08), transparent 60%),
      linear-gradient(180deg,var(--bg),var(--bg2));
    display:grid; place-items:stretch; min-height:100vh;
  }
  .wrap{display:grid; grid-template-rows:auto 1fr auto; gap:12px; max-width:1100px; width:100%; margin:0 auto; padding:18px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding-bottom:8px; border-bottom:1px solid var(--border)}
  h1{font-size:18px; margin:0; letter-spacing:.2px}
  .brand{display:flex; align-items:center; gap:10px}
  .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; font-size:12px; opacity:.9}
  .stats{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .badge{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.10)); border:1px solid var(--border);
         padding:6px 10px; border-radius:999px; display:flex; gap:6px; align-items:center; font-variant-numeric:tabular-nums}
  .badge b{font-weight:700}
  .btn{
    appearance:none; border:1px solid var(--border);
    background:var(--accent); color:#1b0f07; border-radius:12px; padding:8px 12px; cursor:pointer; box-shadow:var(--shadow);
  }
  .btn:hover{background:var(--accent-600); border-color:var(--accent-600)}
  .btn.alt{background:#151a23; color:var(--text)}
  .btn.alt:hover{background:#181e28}
  .frame{position:relative}
  canvas{
    width:100%; height:70vh; max-height:720px; border-radius:16px;
    background:
      radial-gradient(1200px 600px at 50% -220px, rgba(255,122,24,.22), transparent 55%),
      linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.14));
    border:1px solid var(--border); box-shadow:var(--shadow)
  }
  footer{display:flex; gap:10px; align-items:center; justify-content:space-between; color:var(--muted); padding-top:8px; border-top:1px solid var(--border)}
  kbd{font-family:var(--mono); font-size:12px; background:#0f131a; border:1px solid var(--border); padding:2px 6px; border-radius:6px}
  .overlay{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none}
  .panel{
    pointer-events:auto; background:linear-gradient(180deg,var(--panel),var(--panel-2));
    border:1px solid var(--border); padding:18px 16px; border-radius:var(--radius); text-align:center; max-width:560px;
    box-shadow:var(--shadow)
  }
  .panel h2{margin:0 0 6px; font-size:18px}
  .panel p{margin:0 0 12px; color:var(--muted)}
  .row{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
  .hidden{display:none}
  .toast{
    position:absolute; left:50%; transform:translateX(-50%); top:14px;
    background:#0f131a; border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-family:var(--mono);
    box-shadow:var(--shadow)
  }
  .meter{height:6px; background:#0f131a; border:1px solid var(--border); border-radius:999px; overflow:hidden}
  .meter > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#ffc170)}
  /* Scrollbar minimal */
  ::-webkit-scrollbar { height: 10px; width: 10px }
  ::-webkit-scrollbar-thumb { background: #2a3546; border-radius: 10px }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Tower Stacker</h1>
<div class="brand">Webapp by <a href="https://raw-tech.co.uk">RAW-TECH</a></div> 
      <div class="stats">
        <div class="badge">Score: <b id="score">0</b></div>
        <div class="badge">Best: <b id="best">0</b></div>
        <div class="badge" title="Speed"><svg width="12" height="12" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 3a9 9 0 0 0-9 9h2a7 7 0 1 1 7 7v2a9 9 0 0 0 0-18Z"/></svg> <b id="spd">1.0×</b></div>
        <button class="btn alt" id="restartBtn" title="Restart (R)">Restart</button>
      </div>
    </header>

    <div class="frame">
      <canvas id="game" width="1100" height="900" aria-label="Tower Stacker game area"></canvas>

      <div class="overlay" id="overlay">
        <div class="panel" id="panel">
          <h2 id="panelTitle">Tower Stacker</h2>
          <p>Click, tap, or press <kbd>Space</kbd> to drop the moving block. Overhang is cut. Near‑perfect snaps. Width below threshold ends the run.</p>
          <div class="row">
            <button class="btn" id="playBtn">Play</button>
            <button class="btn alt" id="howBtn" title="Controls">Controls</button>
          </div>
          <div style="margin-top:10px; text-align:left">
            <div class="meter" aria-hidden="true"><i id="meter"></i></div>
          </div>
        </div>
      </div>

      <div class="toast hidden" id="toast">Perfect!</div>
    </div>

    <footer>
      <div>Controls: <kbd>Space</kbd>/<kbd>Click</kbd> drop · <kbd>R</kbd> restart</div>
      <div id="status"></div>
    </footer>
  </div>

<script>
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let W = canvas.width, H = canvas.height;

  // UI
  const overlay = document.getElementById('overlay');
  const panel = document.getElementById('panel');
  const panelTitle = document.getElementById('panelTitle');
  const playBtn = document.getElementById('playBtn');
  const howBtn = document.getElementById('howBtn');
  const restartBtn = document.getElementById('restartBtn');
  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const statusEl = document.getElementById('status');
  const spdEl = document.getElementById('spd');
  const meter = document.getElementById('meter');
  const toast = document.getElementById('toast');

  // Game constants
  const LEVEL_H = 32;
  const INIT_W = 360;
  const MIN_W_ABS = 12;
  const SNAP_TOL = 2.0;
  const SPEED_INIT = 2.2;
  const SPEED_INC = 0.12;
  const SPEED_MAX = 9.5;
  const BOUNDS_PAD = 40;

  // palette for blocks
  const COLORS = ['#ff7a18','#f59e0b','#22c55e','#60a5fa','#a78bfa','#f472b6','#34d399'];

  // State
  let stack = [];
  let current = null;
  let dir = 1;
  let speed = SPEED_INIT;
  let score = 0;
  let best = parseInt(localStorage.getItem('stacker.best')||'0',10);
  bestEl.textContent = best;
  let cameraY = 0;
  let running = false;
  let gameOver = false;
  let perfectFlash = 0;   // frames for perfect placement effect
  let combo = 0;          // consecutive perfects

  function reset(){
    stack = [];
    const base = {
      x: (W-INIT_W)/2,
      y: H - 80,
      w: INIT_W,
      h: LEVEL_H,
      color: '#1f2430'
    };
    stack.push(base);
    speed = SPEED_INIT;
    score = 0;
    combo = 0;
    gameOver = false;
    running = true;
    dir = 1;
    cameraY = 0;
    perfectFlash = 0;
    spawnNext(base.w);
    scoreEl.textContent = score;
    statusEl.textContent = '';
    updateSpeedUI();
  }

  function spawnNext(width){
    const top = stack[stack.length-1];
    const startY = top.y - LEVEL_H - 4;
    const leftBound = BOUNDS_PAD;
    const rightBound = W - BOUNDS_PAD - width;
    const startX = Math.random()<0.5 ? leftBound : rightBound;
    current = {
      x: startX,
      y: startY,
      w: Math.max(width, MIN_W_ABS),
      h: LEVEL_H,
      color: COLORS[(stack.length-1)%COLORS.length]
    };
    dir = current.x<=leftBound ? 1 : -1;
  }

  function drop(){
    if(!running || !current) return;
    const prev = stack[stack.length-1];

    const left = Math.max(prev.x, current.x);
    const right = Math.min(prev.x+prev.w, current.x+current.w);
    const overlap = right - left;
    if(overlap <= 0){
      endGame('Missed');
      return;
    }

    let newW = overlap;
    let newX = left;

    const misalign = Math.abs(current.x - prev.x);
    if(misalign <= SNAP_TOL && Math.abs(current.w - prev.w) <= SNAP_TOL){
      newW = prev.w;
      newX = prev.x;
      perfectFlash = 20;
      combo++;
      showToast(combo >= 2 ? `Perfect ×${combo}` : 'Perfect!');
    } else {
      combo = 0;
      hideToast();
    }

    if(newW < MIN_W_ABS){
      endGame('Too thin');
      return;
    }

    current.x = newX;
    current.w = newW;
    current.y = prev.y - LEVEL_H;
    stack.push(current);
    score++;
    scoreEl.textContent = score;

    speed = Math.min(SPEED_MAX, speed + SPEED_INC);
    updateSpeedUI();

    const targetTop = current.y - 220;
    if(targetTop < cameraY){
      cameraY = targetTop;
    }

    spawnNext(current.w);
  }

  function updateSpeedUI(){
    const ratio = (speed - SPEED_INIT) / (SPEED_MAX - SPEED_INIT);
    spdEl.textContent = `${(speed / SPEED_INIT).toFixed(1)}×`;
    meter.style.width = `${Math.max(0, Math.min(100, ratio*100))}%`;
  }

  function endGame(reason){
    running = false;
    gameOver = true;
    statusEl.textContent = `Game over: ${reason}.`;
    if(score > best){
      best = score; localStorage.setItem('stacker.best', String(best));
      bestEl.textContent = best;
    }
    overlay.classList.remove('hidden');
    panelTitle.textContent = `Game Over · Score ${score}`;
    playBtn.textContent = 'Play again';
    hideToast();
    screenShake();
  }

  function step(){
    if(running){
      if(current){
        const leftBound = BOUNDS_PAD;
        const rightBound = W - BOUNDS_PAD - current.w;
        current.x += dir * speed;
        if(current.x <= leftBound){ current.x = leftBound; dir = 1; }
        if(current.x >= rightBound){ current.x = rightBound; dir = -1; }
      }
    }
    draw();
    requestAnimationFrame(step);
  }

  function draw(){
    ctx.save();
    ctx.clearRect(0,0,W,H);

    // Sky gradient
    const grad = ctx.createLinearGradient(0,0,0,H);
    grad.addColorStop(0,'#0f1115');
    grad.addColorStop(1,'#12151c');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,W,H);

    // Subtle stars
    ctx.globalAlpha = 0.12;
    for(let i=0;i<44;i++){
      const x = (i*223)%W;
      const y = (i*101)%H;
      ctx.fillStyle = '#cfe3ff';
      ctx.fillRect(x,y,2,2);
    }
    ctx.globalAlpha = 1;

    // Camera
    ctx.translate(0, -cameraY);

    // Draw stack
    for(let i=0;i<stack.length;i++){
      const b = stack[i];
      drawBlock(b);
    }

    // Draw current with landing guide
    if(current){
      drawBlock(current, true);
    }

    // Perfect flash
    if(perfectFlash>0){
      ctx.save();
      ctx.translate(W/2, (stack[stack.length-1].y - 52));
      ctx.globalAlpha = perfectFlash/20;
      ctx.fillStyle = '#ffead0';
      ctx.font = '700 24px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('Perfect!', 0, 0);
      ctx.restore();
      perfectFlash--;
    }

    ctx.restore();
  }

  function drawBlock(b, hovering=false){
    // drop shadow
    ctx.fillStyle = 'rgba(0,0,0,.28)';
    ctx.fillRect(b.x+3, b.y+6, b.w, b.h);

    // body with rounded rect
    const r = 8;
    roundRect(ctx, b.x, b.y, b.w, b.h, r);
    const grad = ctx.createLinearGradient(b.x, b.y, b.x, b.y+b.h);
    grad.addColorStop(0, shade(b.color, 1.0));
    grad.addColorStop(1, shade(b.color, 0.85));
    ctx.fillStyle = grad;
    ctx.fill();

    // top highlight
    ctx.fillStyle = 'rgba(255,255,255,.15)';
    ctx.fillRect(b.x, b.y, b.w, 4);

    // outline
    ctx.strokeStyle = 'rgba(255,255,255,.12)';
    ctx.lineWidth = 1;
    ctx.stroke();

    if(hovering){
      const prev = stack[stack.length-1];
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = 'rgba(255,122,24,.35)';
      ctx.beginPath();
      ctx.moveTo(BOUNDS_PAD, prev.y);
      ctx.lineTo(W-BOUNDS_PAD, prev.y);
      ctx.stroke();
      ctx.setLineDash([]);
    }
  }

  function roundRect(ctx,x,y,w,h,r){
    if(w<2*r) r = w/2; if(h<2*r) r = h/2;
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }

  function shade(hex, factor){
    const c = parseInt(hex.slice(1),16);
    let r=(c>>16)&255, g=(c>>8)&255, b=c&255;
    r=Math.round(r*factor); g=Math.round(g*factor); b=Math.round(b*factor);
    return '#' + ((1<<24) + (r<<16) + (g<<8) + b).toString(16).slice(1);
  }

  // Minor juice: quick screen shake on fail
  function screenShake(){
    let t = 0;
    const id = setInterval(()=>{
      const dx = (Math.random()-0.5)*10;
      const dy = (Math.random()-0.5)*6;
      canvas.style.transform = `translate(${dx}px,${dy}px)`;
      if(++t>10){ clearInterval(id); canvas.style.transform=''; }
    }, 22);
  }

  // Toast
  let toastTimer = 0;
  function showToast(text){
    toast.textContent = text || 'Perfect!';
    toast.classList.remove('hidden');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(hideToast, 900);
  }
  function hideToast(){ toast.classList.add('hidden'); }

  // Input
  function handleDrop(){
    if(!running){
      if(gameOver){ reset(); overlay.classList.add('hidden'); }
      return;
    }
    drop();
  }

  canvas.addEventListener('click', handleDrop);
  window.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ e.preventDefault(); handleDrop(); }
    if(e.key==='r' || e.key==='R'){ e.preventDefault(); reset(); overlay.classList.add('hidden'); }
  });

  playBtn.addEventListener('click', ()=>{ overlay.classList.add('hidden'); reset(); });
  restartBtn.addEventListener('click', ()=>{ overlay.classList.add('hidden'); reset(); });
  howBtn.addEventListener('click', ()=>{
    panelTitle.textContent = 'Controls';
    panel.querySelector('p').innerHTML =
      'Drop with <kbd>Space</kbd> or click/tap. Align with the block below. Overhang is cut off. Near‑perfect placements snap. '+
      'Width under '+MIN_W_ABS+'px ends the run. <br>Restart with <kbd>R</kbd>.';
  });

  // Resize handling
  function resize(){
    const rect = canvas.getBoundingClientRect();
    const scale = window.devicePixelRatio || 1;
    canvas.width = Math.floor(rect.width * scale);
    canvas.height = Math.floor(rect.height * scale);
    W = canvas.width; H = canvas.height;
    ctx.setTransform(scale,0,0,scale,0,0);
    // keep base on bottom after resize
    if(stack.length){
      const top = stack[0];
      const dy = (H - 80) - top.y;
      for(const b of stack){ b.y += dy; }
      if(current) current.y += dy;
    }
  }
  window.addEventListener('resize', ()=>{ resize(); draw(); });
  resize();

  requestAnimationFrame(step);
})();
</script>
</body>
</html>
